{"version":3,"sources":["../plugin.ts"],"sourcesContent":["import type { Plugin } from \"vite\";\r\nimport MagicString from \"magic-string\";\r\n\r\nexport default function refina() {\r\n  const ctx = { lastFileId: 0, fileIds: new Map<string, string>() };\r\n  return {\r\n    name: \"refina-plugin\",\r\n    enforce: \"pre\",\r\n    transform(code, id) {\r\n      if (!id.endsWith(\".r.ts\")) {\r\n        return null;\r\n      }\r\n      let fileId = ctx.fileIds.get(id);\r\n      if (fileId === undefined) {\r\n        fileId = ctx.lastFileId.toString(36).toUpperCase();\r\n        ctx.lastFileId++;\r\n        ctx.fileIds.set(id, fileId);\r\n        console.log(\"file\", fileId, \"is\", id);\r\n      }\r\n\r\n      let lastKey = 0;\r\n      const getKey = () => `${fileId}-${lastKey.toString(36).toUpperCase()}`;\r\n\r\n      const s = new MagicString(code);\r\n      s.replaceAll(/_\\s*\\.\\s*t\\s*`(.*?)`/g, (_, text) => {\r\n        lastKey++;\r\n        return `_.$$t(\"${getKey()}\", \\`${text}\\`)`;\r\n      });\r\n      s.replaceAll(/_\\s*\\.\\s*([a-zA-Z0-9_]+)\\s*\\(/g, (_, name) => {\r\n        lastKey++;\r\n        return name === \"t\"\r\n          ? `_.$$t(\"${getKey()}\",`\r\n          : `_.$$(\"${name}\", \"${getKey()}\",`;\r\n      });\r\n      s.replaceAll(\r\n        /_\\s*\\.\\s*([a-zA-Z0-9_]+)\\s*\\<([\\s\\S]+?)\\>\\s*\\(/g,\r\n        (_, name, targs) => {\r\n          lastKey++;\r\n          return `_.$$(\"${name}\", \"${getKey()}\",`;\r\n        },\r\n      );\r\n      const map = s.generateMap({\r\n        source: id,\r\n        file: id + \".map\",\r\n        includeContent: true,\r\n      });\r\n      return {\r\n        code: s.toString(),\r\n        map,\r\n      };\r\n    },\r\n  } satisfies Plugin;\r\n}\r\n"],"mappings":";AACA,OAAO,iBAAiB;AAET,SAAR,SAA0B;AAC/B,QAAM,MAAM,EAAE,YAAY,GAAG,SAAS,oBAAI,IAAoB,EAAE;AAChE,SAAO;AAAA,IACL,MAAM;AAAA,IACN,SAAS;AAAA,IACT,UAAU,MAAM,IAAI;AAClB,UAAI,CAAC,GAAG,SAAS,OAAO,GAAG;AACzB,eAAO;AAAA,MACT;AACA,UAAI,SAAS,IAAI,QAAQ,IAAI,EAAE;AAC/B,UAAI,WAAW,QAAW;AACxB,iBAAS,IAAI,WAAW,SAAS,EAAE,EAAE,YAAY;AACjD,YAAI;AACJ,YAAI,QAAQ,IAAI,IAAI,MAAM;AAC1B,gBAAQ,IAAI,QAAQ,QAAQ,MAAM,EAAE;AAAA,MACtC;AAEA,UAAI,UAAU;AACd,YAAM,SAAS,MAAM,GAAG,MAAM,IAAI,QAAQ,SAAS,EAAE,EAAE,YAAY,CAAC;AAEpE,YAAM,IAAI,IAAI,YAAY,IAAI;AAC9B,QAAE,WAAW,yBAAyB,CAAC,GAAG,SAAS;AACjD;AACA,eAAO,UAAU,OAAO,CAAC,QAAQ,IAAI;AAAA,MACvC,CAAC;AACD,QAAE,WAAW,kCAAkC,CAAC,GAAG,SAAS;AAC1D;AACA,eAAO,SAAS,MACZ,UAAU,OAAO,CAAC,OAClB,SAAS,IAAI,OAAO,OAAO,CAAC;AAAA,MAClC,CAAC;AACD,QAAE;AAAA,QACA;AAAA,QACA,CAAC,GAAG,MAAM,UAAU;AAClB;AACA,iBAAO,SAAS,IAAI,OAAO,OAAO,CAAC;AAAA,QACrC;AAAA,MACF;AACA,YAAM,MAAM,EAAE,YAAY;AAAA,QACxB,QAAQ;AAAA,QACR,MAAM,KAAK;AAAA,QACX,gBAAgB;AAAA,MAClB,CAAC;AACD,aAAO;AAAA,QACL,MAAM,EAAE,SAAS;AAAA,QACjB;AAAA,MACF;AAAA,IACF;AAAA,EACF;AACF;","names":[]}